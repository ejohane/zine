name = "zine-worker"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# KV namespace for webhook idempotency
[[kv_namespaces]]
binding = "WEBHOOK_IDEMPOTENCY"
id = "9b2d9ef82c02438ba13184bfc68c2d43"

# KV namespace for OAuth state (CSRF protection)
[[kv_namespaces]]
binding = "OAUTH_STATE_KV"
id = "2101381b080942f9a7799583ccb2e096"

# D1 Database binding (development)
[[d1_databases]]
binding = "DB"
database_name = "zine-db-dev"
database_id = "2ce5331a-233c-48ec-9265-d04ecb539599"
migrations_dir = "src/db/migrations"

# Cron triggers for scheduled ingestion
[triggers]
crons = ["0 * * * *"]  # Run every hour

# Development environment vars
[vars]
ENVIRONMENT = "development"
# CLERK_JWKS_URL = "https://clerk.your-domain.com/.well-known/jwks.json"
# CLERK_WEBHOOK_SECRET = "whsec_..." # From Clerk Dashboard > Webhooks

# Staging environment
[env.staging]
name = "zine-worker-staging"
[[env.staging.kv_namespaces]]
binding = "WEBHOOK_IDEMPOTENCY"
id = "abb1a04762cb4a129218d8c9651adf7c"
[[env.staging.kv_namespaces]]
binding = "OAUTH_STATE_KV"
id = "acb7c409523d4ddeb7941ec2783ace9d"
[[env.staging.d1_databases]]
binding = "DB"
database_name = "zine-db-staging"
database_id = "bc9e61b1-94b2-4f3c-b19b-b3a50936b811"
migrations_dir = "src/db/migrations"
[env.staging.vars]
ENVIRONMENT = "staging"
# Set via wrangler secret: CLERK_WEBHOOK_SECRET

# Production environment
[env.production]
name = "zine-worker-production"
routes = [
  { pattern = "api.myzine.app/*", zone_name = "myzine.app" }
]
[[env.production.kv_namespaces]]
binding = "WEBHOOK_IDEMPOTENCY"
id = "9937928f2eb54074bda5e035dac09c14"
[[env.production.kv_namespaces]]
binding = "OAUTH_STATE_KV"
id = "c58624987cd94f3285ca7f62e5c2fe16"

[[env.production.d1_databases]]
binding = "DB"
database_name = "zine-db-production"
database_id = "82911dea-5a6b-411b-ab4b-4145cb0c191d"
migrations_dir = "src/db/migrations"
[env.production.vars]
ENVIRONMENT = "production"
# Set via wrangler secret: CLERK_WEBHOOK_SECRET

# ============================================================================
# Required Secrets (set via `wrangler secret put <NAME>`)
# ============================================================================
# - CLERK_WEBHOOK_SECRET: Signing secret from Clerk Dashboard > Webhooks
#
# Required KV Namespace (create via `wrangler kv:namespace create WEBHOOK_IDEMPOTENCY`)
# - WEBHOOK_IDEMPOTENCY: KV for webhook idempotency tracking
#
# Required D1 Database (create via `wrangler d1 create <database_name>`)
# - DB: D1 database for user data and sync state
#   Dev:     wrangler d1 create zine-db-dev
#   Staging: wrangler d1 create zine-db-staging
#   Prod:    wrangler d1 create zine-db-prod
#   Then update the database_id values above with the returned IDs.
#
# Optional Variables:
# - CLERK_JWKS_URL: Override default JWKS URL for token verification
