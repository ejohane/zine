name = "zine-worker"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# KV namespace for webhook idempotency
[[kv_namespaces]]
binding = "WEBHOOK_IDEMPOTENCY"
id = "REPLACE_WITH_KV_NAMESPACE_ID"

# D1 Database binding (development)
[[d1_databases]]
binding = "DB"
database_name = "zine-db-dev"
database_id = "REPLACE_WITH_DEV_D1_DATABASE_ID"
migrations_dir = "src/db/migrations"

# Cron triggers for scheduled ingestion
[triggers]
crons = ["0 * * * *"]  # Run every hour

# Development environment vars
[vars]
ENVIRONMENT = "development"
# CLERK_JWKS_URL = "https://clerk.your-domain.com/.well-known/jwks.json"
# CLERK_WEBHOOK_SECRET = "whsec_..." # From Clerk Dashboard > Webhooks

# Staging environment
[env.staging]
name = "zine-worker-staging"
[[env.staging.kv_namespaces]]
binding = "WEBHOOK_IDEMPOTENCY"
id = "abb1a04762cb4a129218d8c9651adf7c"
[[env.staging.d1_databases]]
binding = "DB"
database_name = "zine-db-staging"
database_id = "bc9e61b1-94b2-4f3c-b19b-b3a50936b811"
migrations_dir = "src/db/migrations"
[env.staging.vars]
ENVIRONMENT = "staging"
# Set via wrangler secret: CLERK_WEBHOOK_SECRET

# Production environment
[env.production]
name = "zine-worker-production"
routes = [
  { pattern = "api.myzine.app", zone_name = "myzine.app" }
]
[[env.production.kv_namespaces]]
binding = "WEBHOOK_IDEMPOTENCY"
id = "9937928f2eb54074bda5e035dac09c14"

# Durable Object migration: Delete UserDO class that was previously deployed
[[env.production.migrations]]
tag = "v1-delete-user-do"
deleted_classes = ["UserDO"]

[[env.production.d1_databases]]
binding = "DB"
database_name = "zine-db-production"
database_id = "9020d4fb-d780-4feb-bb6f-7c5a424f2835"
migrations_dir = "src/db/migrations"
[env.production.vars]
ENVIRONMENT = "production"
# Set via wrangler secret: CLERK_WEBHOOK_SECRET

# ============================================================================
# Required Secrets (set via `wrangler secret put <NAME>`)
# ============================================================================
# - CLERK_WEBHOOK_SECRET: Signing secret from Clerk Dashboard > Webhooks
#
# Required KV Namespace (create via `wrangler kv:namespace create WEBHOOK_IDEMPOTENCY`)
# - WEBHOOK_IDEMPOTENCY: KV for webhook idempotency tracking
#
# Required D1 Database (create via `wrangler d1 create <database_name>`)
# - DB: D1 database for user data and sync state
#   Dev:     wrangler d1 create zine-db-dev
#   Staging: wrangler d1 create zine-db-staging
#   Prod:    wrangler d1 create zine-db-prod
#   Then update the database_id values above with the returned IDs.
#
# Optional Variables:
# - CLERK_JWKS_URL: Override default JWKS URL for token verification
